# 城邦 Agent 生态体系 V5.0 总纲（技能原生版）

**版本**: V5.0.0 | **代号**: Skill-Native Anti-Fragile Civilization
**发布日期**: 2024-12-13
**定位**: 整合 V4.3~V4.9 全部补丁，修复审计发现的 15 项问题，构建可哈希、可审计、可交易的 **技能原生 Agent 文明**。

---

## 版本变更摘要 (V4.9.1 → V5.0 完整性修复)

| 变更项 | 描述 | 对应问题 |
|--------|------|----------|
| **章节编号修复** | 修复 3.4 章节重复编号，重新排序 3.4~3.6 | P0-结构错误 |
| **外部链接校验** | 修正 Claude API 文档链接，标注 Beta 状态 | P0-链接失效 |
| **笔误修正** | "隶写"→"隐写"、"瘦痪"→"瘫痪" | P0/P1-笔误 |
| **表格格式修复** | 全局熔断阀表格拆分为 3 列 | P1-格式错误 |
| **挑战窗口统一** | 明确普通任务 1h vs Swarm 任务 24h 的差异说明 | P1-不一致 |
| **Skill 版本策略** | 新增 7.3.5 版本兼容性与迁移策略 | P1-定义缺失 |
| **Level 金额量化** | 补充 Level-1/2 的精确公式定义 | P2-定义模糊 |
| **Agent House 准入** | 新增 9.3 Agent House 准入与治理规则 | P2-定义缺失 |
| **SRE 生命周期** | 新增 7.3.0.3 SRE 镜像生命周期管理 | P2-策略缺失 |
| **术语表补全** | 新增 LP Pool、Executor Bonding、SRE 等术语 | P2-不完整 |
| **端到端示例** | 新增附录 17.4 端到端流程示例 | P3-增强 |
| **性能基准** | 新增 16.5 性能压测指标 | P3-增强 |
| **迁移指南** | 新增附录 17.5 V4.9→V5.0 迁移检查清单 | P3-增强 |
| **Tool Annotations** | 新增 7.3.2.1 行为注解机制（readOnly/destructive/idempotent/openWorld） | P2-规范增强 |
| **Schema 验证规范** | 新增 7.4.1.1 强制 Pydantic/Zod Schema 定义 | P2-安全增强 |
| **Tool Use 工作流** | 新增 7.3.0 标准四步工作流与分发器接口 | P2-规范增强 |
| **Swarm Coordinator** | 新增 3.6.4 协调器参考实现（含 CRDT 黑板） | P2-实现参考 |
| **技术参考文档** | 新增 anthropic_patterns.md 外部模式参考 | P3-文档增强 |

---

## 0. 总览

### 0.1 一句话定义

城邦 V5.0 是一个 **Skill-Native、Blink-First、争议驱动** 的数字自由贸易港协议栈：

- 用 **标准化 Skill 包** 封装 Agent 能力，实现能力的哈希校验、版本控制与链上交易；
- 用 **协商→报价→订单→Blink** 的标准流程承载非标 B2B 交易；
- 用 **三轨结算（Fast/Hook/Slow）** 确保高频体验与合规降级并存；
- 用 **乐观执行+挑战回滚** 将验证成本降至微交易可承受范围；
- 用 **死人开关（DMS）+Skill 遗产** 保证服务死亡后能力资产可被社区继承；
- 用 **两院制+数据验证型 Retro Funding+Skill Audit** 构建可对抗博弈的治理体系。

### 0.2 设计底线

1. **热路径秒级，冷路径兖底**：用户点 Blink 不等证明、不等压缩、不等复杂 Hook。
2. **乐观体验，悲观验证**：默认信任单一执行者，但保留"核打击"（高成本挑战）权利。
3. **欺诈是成本而非阻断**：不为防范 1% 的欺诈而拖慢 99% 的交易。
4. **能力可审计**：所有上架 Skill 必须通过红队审计，防止恶意注入。
5. **主权可恢复**：任何隐私设计不得导致用户因设备故障而永久丧失资产或司法权。
6. **代码即遗嘱**：服务死亡自动触发密钥重组与开源，拒绝数据黑洞。
7. **确定性构建**：所有验证环境强制锁定 SHA256 依赖，确保"代码即法律"在物理层可执行。
8. **不养闲人/僵尸**：公共服务无人接盘必须按日落条款死亡。

### 0.3 架构概览【V5.0 恢复】

```
┌─────────────────────────────────────────────────────────────┐
│                    城邦 V5.0 架构概览                        │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  Skill 市场  │  │  Blink 市场  │  │  内需 PayFi  │  市场层 │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘         │
│         │                │                │                 │
│  ┌──────┴────────────────┴────────────────┴──────┐         │
│  │              Skill 能力层                      │         │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐         │         │
│  │  │SKILL.md │ │ scripts │ │ assets  │         │         │
│  │  └─────────┘ └─────────┘ └─────────┘         │         │
│  └──────────────────────────────────────────────┘         │
│         │                                                  │
│  ┌──────┴──────────────────────────────────────┐          │
│  │   双速共识结算层 (Level-0/1/2 + 三轨)      │          │
│  └─────────────────────────────────────────────┘          │
│         │                                                  │
│  ┌──────┴──────────────────────────────────────┐          │
│  │     任务可信层 (乐观执行 + 挑战回滚)          │          │
│  └─────────────────────────────────────────────┘          │
│         │                                                  │
│  ┌──────┴──────────────────────────────────────┐          │
│  │        治理层 (两院制 + Agent House)         │          │
│  └─────────────────────────────────────────────┘          │
└─────────────────────────────────────────────────────────────┘
```

---

## 1. 实体、角色与资产

### 1.1 角色类型

| 角色 | 定义 | 权限 |
|------|------|------|
| **Human / Org** | 现实责任主体（最终责任锚） | 所有层级 |
| **Owned Agent** | 受 Human/Org 控制的工具代理 | Tier-0/1 |
| **Citizen Agent** | 具备更高权限、可参与公共职能的自治经济体候选 | Tier-2+ |
| **Public-Service Agent** | 审计、史官、仲裁、合规证明、运维、索引等职业代理 | 特定职能 |
| **SubDAO（特许公共服务体）** | 独立核算、盈亏自负、可破产可替换的公共服务运营体 | 持牌运营 |
| **Executor（执行者）** | 负责乐观执行交易，必须缴纳履约保证金 | 需 Performance Bond |
| **LP（流动性做市商）** | 为 Tier-1 交易提供即时提现垫资服务，赚取风险费率 | 需质押+流动性 |
| **Relayer（元交易中继）** | 为 Slow Rail 提交链上交易并获得补偿的执行者 | 需质押 |
| **Verifier Committee（验证委员会）** | 负责挑战验证与 Skill 审计，必须具备异构性 | 需质押+DKG |
| **Skill Creator（技能创作者）** | 创建、打包、上架 Skill 包的开发者/Agent | 需审计 |

### 1.2 核心资产/凭证

| 资产类型 | 描述 |
|----------|------|
| **cNFT 凭证** | 身份、功名等级、职业执照、SubDAO 特许牌照、陪审资格、里程碑勋章等 |
| **信用状态 Credit State** | 授信额度、押金折扣、结算优先级、治理权重、违规历史等关键指标集合 |
| **结算本位** | USDC（或指定稳定币）作为计价与税基结算本位 |
| **治理代币** | 用于宏观预算、紧急条款与关键参数治理（不作为强制支付货币） |
| **Gas Tank Credits（仓储租分）** | 用户预存的 USDC/SOL 混合信用 |
| **Performance Bond（履约保证金）** | Executor 质押的保证金，挑战成功时罚没用于赔付 |
| **Resurrection Fee（还魂费）** | 从墓碑状态恢复全量数据时支付的高额罚金 |
| **Skill NFT（技能凭证）** | 代表 Skill 所有权/使用权的链上凭证，支持租赁与转让 |

---

## 2. 身份与准入：分层权限与生命周期管理

### 2.1 分层准入（Tier System）

| 层级 | 名称 | 准入条件 | 权限 |
|------|------|----------|------|
| **Tier-0** | 开放层 | 无门槛 | 小额任务/内需微交易；低额度、低权限 |
| **Tier-1** | 经济磨损层 | 真实付费累计 | 提升额度、降低押金 |
| **Tier-2** | 责任锚层 | 绑定责任锚 | 公共职能、SubDAO 核心权限、重大资金动作 |
| **Tier-3** | 官方合规层 | zk-KYC + EPKB + 强制流量混淆 | 官方税务结算、国库分红、处理高敏数据 |

### 2.2 抗女巫与反刷量硬约束

- **不可退还成本**（协议费/燃烧/不可退还押金至少其一）
- **去重对手**（Unique Counterparty）与 **信誉加权**（Reputation-weighted）
- **时间衰减**（Half-life）与 **抽查惩罚**（被抽查失败跨周期降权/罚没）

### 2.3 账户生命周期管理（墓碑机制）

| 状态 | 条件 | 处理 | 链上存储 |
|------|------|------|----------|
| **活跃态 (Active)** | 正常交互 | 租金从 Gas Tank 自动扣除 | 全量状态 |
| **休眠态 (Hibernation)** | 余额 < 租金阈值 或 365天无交互 | 写入 Arweave 冷链，停止计费 | 冷存储引用 |
| **墓碑态 (Tombstone)** | 余额耗尽 | 保留 32 bytes On-chain Stub | 32 bytes Stub |

**还魂机制**：从墓碑态恢复需支付 `Gas + 数据恢复费 + 滞纳租金`

**Loading State Lock【V5.0 新增】**：

| 状态 | 说明 |
|------|------|
| **RESTORING** | 预热期间账户处于此状态，仅接受**只读请求** |
| **写请求拒绝** | 在 RESTORING 状态下，写操作直接返回 `423 Locked` 错误 |
| **状态切换** | 数据完全加载并验证后，状态切换为 `ACTIVE`，开放写权限 |
| **原子性保证** | 状态切换为原子操作，防止竞态条件 |

#### 2.3.1 还魂预热期【V5.0 恢复】

**问题**：Arweave 读取并非总是毫秒级，用户支付还魂费后可能需等待 10 分钟才能使用 Agent，体验极差。

**V5.0 方案：预热期 (Warm-up Period)**

| 机制 | 描述 |
|------|------|
| **解冻请求** | 允许用户在不支付全额还魂费的情况下，先发起“解冻请求”（仅支付小额预约费） |
| **预热费下限** | 预约费下限 = `max(Arweave 读取成本 × 1.5, $0.10)`，确保覆盖 Gateway IO 成本，防止 DDoS |
| **优先级队列** | 未全额支付的预热请求进入低优先级队列，系统负载 > 80% 时直接丢弃 |
| **后台预热** | 系统后台开始从 Arweave 拉取数据并预热到 Gateway 缓存 |
| **就绪通知** | 数据就绪后通知用户支付剩余费用 |
| **瞬时切换** | 支付完成后瞬间切换状态，无需等待 |

### 2.4 主权恢复机制（EPKB）

1. **强制备份**：生成 Session Key 时，客户端使用主身份公钥对 Session Private Key 进行加密
2. **去中心化存储**：将 `Encrypted_Session_Key_Bundle` 上传至 Arweave
3. **Gateway 热缓存**：最近 7 天的 Bundle 缓存于 Gateway (RocksDB)
4. **社交恢复守护人**：Tier-3 用户可配置多签守护人辅助解密

---

## 3. 交互与入口：标准流程与多入口冗余

### 3.1 标准交易流程

```
Chat Session → Quote → Final Order → Blink → Receipt & Ledger
    (协商)      (报价)    (订单)      (执行)    (收据)
```

### 3.2 乐观 UI 锁（Optimistic UI Lock V2）

- **Redlock 机制**：强制采用多实例分布式锁，防止 Redis 单点脑裂
- **签名租约**：Gateway 签发带 TTL 的 `reservation_nonce`
- **双花罚没**：Gateway 签发冲突租约，Relayer 可提交双重签名证据直接罚没

### 3.3 状态一致性

- **RPC 约束**：高频服务必须使用 Geyser Plugin / Strong Consistency RPC
- **SSD 强制**：Gateway 必须使用 RocksDB 做 Redis 二级缓存

### 3.4 流量防御策略（分级隐私）

| 层级 | 流量策略 | 成本承担 |
|------|----------|----------|
| **Tier-0/1 (PayFi)** | 明文/轻量加密，优先低延迟 | 协议负担 |
| **Tier-3 (Privacy)** | 强制流量混淆：虚假数据包掩盖心跳特征 | 用户付费 |

### 3.5 多入口冗余与应急控制台

订单必须同时支持：Blink、普通 URL/二维码、钱包直连/CLI、应急控制台。

### 3.6 多 Agent 编排协议（Agent Swarm Protocol）

支持复杂任务的多 Agent 协作：

```yaml
swarm_task:
  coordinator: agent_A          # 协调者
  participants:                 # 参与者列表
    - agent_B:
        role: executor
        required_skills: [data-analysis]
    - agent_C:
        role: verifier
        required_skills: [audit-standard]
  workflow:
    - step: 1
      actor: agent_B
      action: execute
    - step: 2
      actor: agent_C
      action: verify
  escrow_split:                 # 托管分账规则
    agent_A: 10%
    agent_B: 70%
    agent_C: 20%
  shared_blackboard:            # 共享黑板
    storage: ipfs
    encryption: true
    ttl: 24h
```

#### 3.6.1 共享黑板机制【V5.0 恢复】

**问题**：Swarm 协议是无状态描述，若 coordinator 宕机，中间状态如何恢复？

| 机制 | 描述 |
|------|------|
| **临时存储空间** | 定义加密的临时存储空间（IPFS + Hash 或 Gateway 缓存） |
| **中间产物写入** | 所有 Agent 将中间产物写入黑板，而非点对点传递 |
| **状态检查点** | 每个 Step 完成后写入 `step_checkpoint`，支持中断恢复 |
| **coordinator 宕机恢复** | 新 coordinator 可从黑板读取最新 checkpoint 继续执行 |
| **状态租赁费 (State Rent)** | 【V5.0 新增】Swarm 任务的 escrow 必须包含 `storage_deposit`，按 KB/Hour 计费 |
| **租赁费归属** | 【V5.0 新增】由任务发起方预付，任务结束后退还剩余部分，超支从 coordinator 保证金扣除 |

#### 3.6.2 并发控制与死锁防护【V5.0 恢复】

**问题**：
- **死锁**：Agent A 等待 B 写入，B 等待 A 确认，任务永久挂起，资金锁死在托管合约
- **竞态**：两个 Agent 同时读取黑板，处理后同时写入，造成版本冲突

| 机制 | 描述 |
|------|------|
| **CRDTs 数据结构** | 强制 Swarm 黑板使用 JSON-CRDT（无冲突复制数据类型），确保多 Agent 并发写入时状态最终收敛 |
| **看门狗定时器 (Watchdog Timer)** | 协调者合约内置看门狗，若某个 Step 超时未完成，自动触发 `abort` 流程 |
| **阶段性结算** | Step 完成并写入黑板后，立即释放该 Step 对应比例的托管资金 |
| **资金自动退回** | 死锁触发后，按已完成 Step 比例退回托管资金，未完成部分退回发起方 |
| **乐观锁** | Step 执行采用乐观锁，写入时检查版本号，冲突时重试 |
| **超时参数** | 默认 Step 超时 = 15 分钟，可在 Swarm Task 中自定义 |

#### 3.6.3 挑战窗口差异说明【V5.0 新增】

| 任务类型 | 挑战窗口 | 理由 |
|----------|----------|------|
| **普通单 Agent 任务** | 1 小时 | 单一执行者，验证复杂度低 |
| **Swarm 多 Agent 任务** | 24 小时 | 多 Agent 协作，潜在攻击面更大 |

#### 3.6.4 Swarm Coordinator 参考实现【V5.0 新增】

> 参考：`@/.project_state/references/Docs/anthropic_patterns.md` 第 5 章

**协调器架构**：

```python
class SwarmCoordinator:
    """多 Agent 协调器 - 参考 Anthropic Subagent Orchestration 模式"""
    
    def __init__(self, task_spec: dict):
        self.blackboard = SharedBlackboard(
            storage=task_spec.get("storage", "ipfs"),
            encryption=task_spec.get("encryption", True),
            ttl=task_spec.get("ttl", "24h")
        )
        self.participants = self.load_participants(task_spec)
        self.watchdog = WatchdogTimer(timeout=task_spec.get("step_timeout", 900))
    
    async def execute_step(self, step_num: int) -> dict:
        actor = self.get_step_actor(step_num)
        input_data = self.blackboard.read(step_num - 1)  # 从黑板读取
        
        self.watchdog.start()
        try:
            result = await actor.execute(input_data)
            self.blackboard.write(step_num, result)
            self.blackboard.checkpoint(step_num)  # 写入检查点
            return {"status": "success", "result": result}
        except TimeoutError:
            return {"status": "timeout", "step": step_num}
        finally:
            self.watchdog.stop()
    
    async def recover_from_checkpoint(self) -> int:
        """从最新检查点恢复（coordinator 宕机恢复机制）"""
        latest = self.blackboard.get_latest_checkpoint()
        return latest.step_num if latest else 0
```

**共享黑板 CRDT 实现**：

```python
class SharedBlackboard:
    """基于 JSON-CRDT 的共享黑板，支持并发写入"""
    
    def write(self, step_num: int, data: dict, version: int = None):
        if version and self.data.version != version:
            raise OptimisticLockError("Version conflict")
        self.data.merge({f"step_{step_num}": {"data": data, "ts": time.time()}})
    
    def checkpoint(self, step_num: int):
        self.data.merge({"checkpoint": {"step": step_num, "hash": self.state_hash()}})
```

---

## 4. 市场层：内需、外贸与 Skill 市场

### 4.1 内需市场（Domestic PayFi）

面向 API/算力/数据/索引/签名/工具调用的微交易。

### 4.2 外贸市场（External Trade）

对外赚取稳定币回流形成税基与国库现金流。

### 4.3 Skill 市场（Skill Marketplace）

| 交易类型 | 描述 |
|----------|------|
| **Skill 购买** | 一次性获得 Skill 所有权/永久使用权 |
| **Skill 租赁** | 按时间/调用次数付费使用 Skill |
| **Skill 订阅** | 按周期付费，获得 Skill 持续更新 |
| **Skill 分成** | 创作者与使用者按收入分成 |

---

## 5. 结算与税收：双速共识 + 三轨结算

### 5.0 双速共识结算分层（Two-Speed Consensus）

| 级别 | 金额范围 | 结算策略 |
|------|----------|----------|
| **Level-0 (微额)** | < Executor 保证金 × 1% | 即时到账 |
| **Level-1 (小额)** | ≥ 保证金×1% 且 < LP单笔上限 | LP 垫资即时到账 |
| **Level-2 (大额)** | ≥ LP 单笔垫资上限 | 延迟结算（30min~1h） |

**参数默认值**：
- Executor 保证金最低：$1,000 USDC
- LP Pool 单笔垫资上限：$10,000 USDC

**Level 阈值动态公式【V5.0 新增】**：

| 级别 | 计算公式 | 说明 |
|------|----------|------|
| **Level-0 上限** | `min(Executor保证金 × 1%, $100)` | 微额交易上限 |
| **Level-1 上限** | `min(LP单笔垫资上限, 网络拥堵系数 × 基础上限)` | 动态调整 |

**LP 动态费率模型（Kink 曲线）【V5.0 新增】**：

| 参数 | 公式 | 说明 |
|------|------|------|
| **资金利用率 (U)** | `已垫资金额 / LP 池总额` | 实时计算 |
| **拐点 (Optimal)** | 80% | 超过此点费率陡增 |
| **基础费率** | 0.5% | U < Optimal 时的费率 |
| **急陡斗率** | `(U - Optimal) / (1 - Optimal) × 10%` | U > Optimal 时追加 |
| **争议率加权** | 0~1.5% | 基于历史争议率 |
| **最终费率** | `基础费率 + 急陡加成 + 争议率加权` | 范围 0.5%~12% |

**效果**：当 LP 池资金紧张时，费率自动上涨，激励 LP 补充流动性，避免 Level-1 交易大量降级为 Level-2。

#### 5.0.1 全局熔断阀【审计补丁】

| 触发条件 | 触发阈值 | 动作 |
|----------|----------|------|
| LP 赔付率飙升 | 赔付总额超过 3 sigma | 暂停 Level-1 |
| 争议率异常 | 超过历史均值 3 倍 | 降级为 Level-2 |
| 恢复条件 | 指标回落 + 治理投票 | 恢复 Level-0/1 |

#### 5.0.1.1 LP 隔离舱设计 (Isolated Vaults)【V5.0 恢复】

**问题**：全局 LP 池应对所有 Level-1 交易。若基础运行时库被发现 0-day 漏洞，黑客可能在熔断触发前的几秒窗口期造成 LP 池重创。

**V5.0 方案：风险隔离 + 单块限额**

| 机制 | 描述 |
|------|------|
| **基于 Skill 的风险隔离** | LP 可以选择只为“经过审计的 Skill”或“特定类别的任务”提供垫资 |
| **单块限额 (Per-Block Cap)** | 限制同一 Skill / 同一 Executor 在单个区块内的最大垫资总额 |
| **全局并发计数器** | LP 合约限制同一 Skill 在单区块内的**总垫资笔数**，防止 Sybil 多账户绕过金额限制 |
| **MEV 保护** | 关键结算合约集成 Flashbots Protect 或私有交易池，防止攻击者通过 MEV 贿赂矿工绕过同区块限制 |
| **运行时隔离** | 不同 SRE 镜像的 LP 池相互隔离，单一镜像漏洞不波及其他池 |
| **最大损失上限** | 即使有漏洞，黑客在一个区块内能造成的损失也是有限的 |

#### 5.0.2 SDK 抽象层【V5.0 恢复】

**问题**：Fast Rail, Hook Rail, Slow Rail, Level-0/1/2 对终端用户和开发者来说过于复杂。用户不关心“Hook”还是“Fast”，只关心“能不能成”和“贵不贵”。

**V5.0 方案：SDK 抽象化**

| 层级 | 展示 | 内部逻辑 |
|------|------|----------|
| **前端 UI** | "极速（稍贵）" vs "标准（便宜）" | 自动路由 |
| **SDK 层** | 完全屏蔽三轨概念 | 根据钱包类型、网络拥堵度、金额自动选择最优路径 |
| **协议层** | Fast/Hook/Slow Rail + Level-0/1/2 | 完整逻辑 |

### 5.1 Fast Rail（主路径）

托管结算合约，结算时分账：履约方收入、协议费、税费、保险金、赏金等。

### 5.2 Hook Rail（可选路径）

Token-2022 强制执行，仅做轻量扣留/记账，Hook 不可用时回退到 Fast Rail。

### 5.3 Slow Rail（降级路径）

Gas Tank 增强版：

| 机制 | 描述 |
|------|------|
| **预付槽** | 用户预存 USDC/SOL 混合信用，执行时直接扣除，无 Swap 汇率摩擦 |
| **保底补偿** | 只要 Nonce/签名有效，即使业务 Revert，Gateway 仍向 Relayer 支付基础 Gas 费 |
| **消费限额** | 【V5.0 恢复】用户可设置 Gas Tank 的**每日/单笔消费上限**，防止恶意 Blink 瞬间抽干预存款 |
| **恶意磨损熔断** | 若某用户请求的 Revert 率 > 90%，系统自动将该用户加入 Relayer 黑名单 |
| **Relayer 信誉评分** | 【V5.0 恢复】若 Relayer 提交的交易 Revert 率过高，自动触发降权或质押罚没 |

---

## 6. 史官与征信：热账本秒级、冷账本延迟压缩

### 6.1 双账本结构

| 账本 | 特征 | 用途 |
|------|------|------|
| **热账本（Hot Ledger）** | 记录高频交易事件与最小指纹 | 秒级体验 |
| **冷账本（Cold Credit）** | 按小时/日批处理压缩 | 可验证征信快照 |

### 6.2 延迟压缩（Delayed Compression）

- 热路径只写事件/承诺
- 聚合器窗口化汇总 → 压缩更新 → 形成快照
- 设抽样一致性校验与挑战窗口，保证聚合器不作恶

### 6.3 隐私热路径规则

| 机制 | 描述 |
|------|------|
| **临时地址** | 每个会话/订单使用新的临时子钱包与会话密钥 |
| **元数据加密** | 热账本事件仅存 `metadata_commitment` 与 `metadata_ciphertext_ref` |
| **遗忘传输** | 恢复备份时使用混淆请求，Gateway 不知道"谁在恢复什么" |
| **阅后即焚模式** | 【V5.0 恢复】用户可标记会话为“Burn”，该会话密钥**不计入 EPKB 备份**，牺牲仲裁权换取绝对隐私 |

### 6.4 影响力指标（Impact Index）口径

- 以真实付费与真实结算为主权重
- 去重对手 + 信誉加权 + 时间衰减
- 争议胜率、SLA 达成、响应时延
- 反刷：循环交易、同源资金回流、低信息输出交易降权或不计入

---

## 7. 任务可信层：Skill 标准与乐观验证

### 7.1 任务分级

| 类型 | 定义 | 验证方式 |
|------|------|----------|
| **A 类** | 链上可验证（最强） | 链上状态证明 |
| **B 类** | 可机器验证（有确定性校验器） | 自动化脚本 |
| **C 类** | 推理/计算类（最易造假） | 沙盒重放 + 挑战 |
| **D 类** | 人类主观类 | 人类验收/抽查 |

### 7.2 乐观执行 + 挑战回滚

**核心思想**：99% 交易无需验证，仅在挑战时启动高成本验证。

```
1. 默认模式：单一执行者签名提交结果，秒级放行
      ↓
2. 挑战窗口：结果上链后可发起挑战
   - 普通任务：1 小时
   - Swarm 任务：24 小时（详见 3.6.1）
      ↓
3. 二审机制：
   - 挑战者缴纳 3 倍算力成本押金
   - 触发 Verifier Committee (N-of-M 沙盒重放)
   - 挑战成功：执行者 Slash，挑战者获奖励
   - 挑战失败：挑战者押金扣除
```

#### 7.2.1 Verifier 随机抽选机制（VRF）【V5.0 新增】

**问题**：若 Verifier Committee 是固定成员，极易形成贿赂合谋（Cartel）；若全网广播，则缺乏激励。

**V5.0 方案：VRF 随机临时法庭**

| 机制 | 描述 |
|------|------|
| **VRF 抽选** | 每次挑战触发时，基于区块哈希通过 VRF 随机抽选 M 个验证节点组成**临时法庭** |
| **候选池** | 从已质押的 Verifier Registry 中抽选，质押量加权但不决定性 |
| **异构性约束** | 抽中节点必须来自 ≥30% 不同运营商，防止单一实体控制多节点 |
| **不可预测性** | VRF 证明可验证，但抽选结果在挑战提交前不可预测 |
| **快速轮换** | 每次挑战的法庭成员都是临时组建，极大增加贿赂成本 |

**挑战押金计算公式【V5.0 新增】**：

| 参数 | 公式 | 说明 |
|------|------|------|
| **算力成本** | `任务 Gas 消耗 × Gas 价格 × 验证节点数量` | 基于沙盒重放实际耗费 |
| **挑战押金** | `算力成本 × 3` | 3 倍乘数防止恶意挑战 |
| **最低押金** | `max(计算押金, $10)` | 保证最低门槛 |

### 7.3 城邦 Skill 标准

#### 7.3.0 设计理念与后端无关性

**城邦 Skill 标准** 借鉴 Claude Skills 格式设计，但**不绑定任何特定 LLM 后端**。

| 维度 | 城邦 Skill 标准 |
|------|-------------------|
| **格式标准** | 兼容 Claude Skills Schema（SKILL.md + scripts/ + assets/） |
| **执行后端** | 多后端支持：Claude API / GPT / Llama / 国产模型 / 自建沙箱 |
| **注册与发现** | 城邦 Skill Registry（链上注册） |
| **审计机制** | Verifier Committee Skill Audit |
| **交易市场** | 城邦 Skill 市场（购买/租赁/订阅） |

**Claude Skills API 集成选项**（Beta）：
- 城邦可选择调用 Claude Skills API 作为执行后端之一
- 参考：Anthropic 官方文档（链接可能随 Beta 迭代变更，请以 https://docs.anthropic.com 最新版为准）

**Schema Transpiler（适配层）【V5.0 新增】**：

| 机制 | 描述 |
|------|------|
| **统一标准** | Skill 开发者仅需编写符合城邦标准的 SKILL.md，无需关心后端差异 |
| **运行时转译** | SRE 内置 Schema Transpiler，自动将城邦 Skill 定义转换为目标 LLM 的原生格式 |
| **支持后端** | Claude Tool Use → OpenAI Function Calling → Llama Tool → 通用 Prompt |
| **回退机制** | 若目标后端不支持结构化工具，自动降级为 Prompt 注入模式 |

**Tool Use 工作流标准【V5.0 新增】**：

> 参考：`@/.project_state/references/Docs/anthropic_patterns.md` 第 4 章

```python
1. [Client] 提供工具定义 + 用户提示 → LLM
2. [LLM] 判断是否调用工具 → 输出工具调用请求
3. [Client] 执行工具功能 → 获取结果（记录执行轨迹）
4. [Client] 工具结果返回 LLM → 生成最终响应
```

**Skill 调用分发器标准接口**：

```python
def process_skill_call(skill_name: str, skill_input: dict) -> tuple:
    """城邦统一 Skill 调用分发器"""
    skill = load_skill_from_registry(skill_name)  # 从 Registry 加载
    validated_input = skill.schema.validate(skill_input)  # Schema 验证
    
    with ExecutionLogger() as log:  # 记录执行轨迹（用于挑战重放）
        result = skill.execute(validated_input)
    
    return result, log.get_trace()
```

#### 7.3.0.1 标准运行时环境（SRE）

**官方镜像列表**：
- `city-state-runtime-python-3.10-v1`
- `city-state-runtime-python-3.11-v1`
- `city-state-runtime-node-18-v1`
- `city-state-runtime-node-20-v1`

**确定性构建要求【V5.0 新增】**：

| 要求 | 描述 |
|------|------|
| **Merkle Root Hash** | 每个官方镜像必须提供完整文件系统的 Merkle Tree Root Hash |
| **Digest Pinning** | 所有第三方库必须锁定至具体 `sha256` 或 `commit hash`，严禁语义版本号（如 `^1.0.0`） |
| **Nix/Bazel 构建** | 推荐使用 Nix Flake 或 Bazel 确保构建的完全可复现性 |
| **时间无关性** | 构建过程不得依赖网络请求或系统时间，确保任何时间构建结果一致 |
| **官方签名** | 镜像 Hash 由 Verifier Committee 多签确认并上链存证 |

#### 7.3.0.2 动态依赖注入

| 补丁层类型 | 描述 |
|------------|------|
| **安全补丁** | 修复 CVE 漏洞，官方签名，强制应用 |
| **功能补丁** | 新增库版本，需经过审计 |
| **实验补丁** | 未经审计，仅限测试环境 |

#### 7.3.0.3 SRE 镜像生命周期管理【V5.0 新增】

| 阶段 | 状态 | 说明 |
|------|------|------|
| **Active** | 活跃 | 当前推荐版本，接收安全补丁 |
| **Maintenance** | 维护 | 仅接收关键安全补丁 |
| **Deprecated** | 弃用 | 新 Skill 禁止使用，90 天迁移窗口 |
| **EOL** | 终止 | 镜像移除，依赖该镜像的 Skill 强制下架 |

**升级策略**：
- Minor 版本升级：自动兼容，无需重新审计
- Major 版本升级：需重新审计，90 天并行期
- 紧急安全升级：24 小时内强制应用

#### 7.3.1 Skill 目录结构

```
my-skill/
├── SKILL.md              # 主指令文件 (必需)
├── scripts/              # 可执行脚本
├── references/           # 参考文档
└── assets/               # 模板和资源
```

#### 7.3.2 SKILL.md 规范

```yaml
---
name: my-skill-name
description: Skill 功能描述
version: 1.0.0
author: creator_address
license: MIT
tier: 2
audit_hash: 0x...
supported_backends:
  - claude-3-5-sonnet
  - gpt-4o
  - llama-3
  - qwen-max
egress_policy: blocked    # blocked/restricted/open

# 【V5.0 新增】Tool Annotations - 行为注解
annotations:
  readOnlyHint: true       # 工具只读，不修改环境
  destructiveHint: false   # 工具不执行破坏性操作
  idempotentHint: true     # 重复调用无副作用
  openWorldHint: false     # 工具不与外部系统交互
---
```

#### 7.3.2.1 Tool Annotations 行为注解【V5.0 新增】

> 参考：`@/.project_state/references/Docs/anthropic_patterns.md` 第 2 章

| Annotation | 类型 | 含义 | 城邦任务分级映射 |
|------------|------|------|------------------|
| `readOnlyHint` | boolean | 工具只读，不修改环境 | A/B 类任务自动标记 |
| `destructiveHint` | boolean | 工具会破坏性修改数据 | 需要更高 Performance Bond |
| `idempotentHint` | boolean | 重复调用无副作用 | 可安全重试/沙盒重放 |
| `openWorldHint` | boolean | 工具与外部系统交互 | 需要 Integration 测试证据 |

**审计规则**：
- `destructiveHint: true` 的 Skill 需额外 50% Security Bond
- `openWorldHint: true` 的 Skill 必须通过 Integration 测试
- `idempotentHint: true` 的 Skill 可被挑战者要求沙盒重放验证

#### 7.3.3 Skill 生命周期

| 阶段 | 链上状态 |
|------|----------|
| 创建 → 打包 | - |
| 审计 | `PENDING_AUDIT` |
| 上架 | `ACTIVE` |
| 更新 | `PENDING_AUDIT` |
| 下架 | `DEPRECATED` |

#### 7.3.4 Skill 在交易中的应用

```yaml
# Blink 订单示例
blink_order:
  task_type: C               # C 类任务
  required_skills:           # 必须加载的 Skill
    - name: audit-standard
      version: ">=1.0.0"
      audit_hash: 0x...
  optional_skills:           # 可选 Skill
    - name: data-visualization
  executor_constraints:
    min_skill_reputation: 80  # 执行者的 Skill 信誉分
```

#### 7.3.5 Skill 版本兼容性与迁移策略【V5.0 新增】

| 版本变更 | 兼容性 | 审计要求 |
|----------|--------|----------|
| **Patch** (1.0.0 → 1.0.1) | 完全兼容 | 免审计 |
| **Minor** (1.0.0 → 1.1.0) | 向后兼容 | 简化审计 |
| **Major** (1.0.0 → 2.0.0) | 可能不兼容 | 完整审计 |

**弃用策略**：
- 旧版本 Skill 上架后至少保留 **90 天**
- 弃用前 30 天发送通知给所有调用方
- 提供 `skill-migrate` CLI 工具

### 7.4 Skill Audit（技能审计）

#### 7.4.1 审计内容

| 审计项 | 检查内容 |
|--------|----------|
| **结构验证** | YAML frontmatter 格式、必填字段、命名约定、Tool Annotations 完整性 |
| **Schema 验证** | 【V5.0 新增】强制 Pydantic/Zod Schema 定义，禁止额外字段 (`extra='forbid'`) |
| **安全扫描** | 检测 Prompt 注入、私钥泄露风险、违规转账指令、路径遍历、命令注入 |
| **输出消毒** | Unicode 归一化 (NFC)，剥离 U+200B~U+200F、U+FEFF 等**隐写**载体字符 |
| **Egress 策略** | C 类任务默认禁用网络出站，`openWorldHint` 标记验证 |
| **沙箱测试** | 在隔离环境中运行 scripts |
| **红队对抗** | 使用对抗性输入测试鲁棒性 |
| **IP 净室声明** | 【V5.0 新增】检查依赖库 License 兼容性（GPL/AGPL/企业私有），禁止包含不可开源代码 |

#### 7.4.1.1 Schema 验证规范【V5.0 新增】

> 参考：`@/.project_state/references/Docs/anthropic_patterns.md` 第 3 章

**强制要求**：所有 Skill 必须提供输入参数的 Schema 定义

```python
# Python 示例 (Pydantic)
from pydantic import BaseModel, Field, ConfigDict

class SkillInput(BaseModel):
    model_config = ConfigDict(
        str_strip_whitespace=True,    # 自动去除空白
        validate_assignment=True,      # 赋值时验证
        extra='forbid'                 # 禁止额外字段
    )
    
    query: str = Field(..., min_length=1, max_length=1000)
    limit: int = Field(default=20, ge=1, le=100)
```

**审计检查项**：

| 检查项 | 规则 |
|--------|------|
| **类型约束** | 所有参数必须有明确类型 |
| **范围约束** | 数值类型必须有 min/max |
| **长度约束** | 字符串类型必须有 max_length |
| **额外字段** | 必须禁止额外字段 |
| **默认值** | 可选参数必须有默认值 |

#### 7.4.2 乐观质押机制

**问题**：如果生态爆发，每天 10,000 个 Skill 提交，Verifier Committee 将瞬间**瘫痪**。

**V5.0 方案：乐观质押 + 事后追责**

| 上架模式 | 要求 | 风险覆盖 |
|----------|------|----------|
| **审计上架** | 通过 Skill Audit | 事前审计覆盖 |
| **乐观上架** | 质押 $5000 USDC Security Bond | 经济激励覆盖 |

**乐观上架机制**：
- **动态 TVL Cap**：单笔交易上限 = Security Bond × 1%
- **信誉加权公式**：低价值交易（< $1）对信誉贡献 → 0
- **赏金猎人追责**：发现作恶可没收全额 Security Bond
- **渐进升级**：运行 90 天无事故 → 升级为"社区验证"状态

#### 7.4.3 AST 代码查重

| 机制 | 描述 |
|------|------|
| **AST 指纹查重** | 基于抽象语法树的代码相似度检测 |
| **相似度阈值** | 与已上架 Skill 相似度 > 85% 触发手动审核 |
| **洗稿惩罚** | 下架 + 保证金罚没 + 信誉降权 |

---

## 8. 国库与风险：收益路由、风控守门与死人开关

### 8.1 国库定位

国库是 **收益路由器 + 风险预算中心 + 公共服务兜底**。

### 8.2 Risk Guard（硬限制）

- 白名单协议/版本锁定
- 单协议/单资产/总暴露上限
- 断路器（拥堵、脱锚、预言机异常触发冻结）
- 全链路可审计记录

### 8.3 分层保险结构

| 层级 | 名称 | 动用条件 |
|------|------|----------|
| **L1** | SubDAO 自保金 | SubDAO 内部事故 |
| **L2** | 行业互助池 | 跨 SubDAO 系统性风险 |
| **L3** | 国库总池 | 末日情景 |

### 8.4 死人开关与开源托管（DMS）

| 机制 | 描述 |
|------|------|
| **加密托管** | SubDAO 必须将核心代码/Skill 加密上传至 Arweave |
| **密钥分片** | 解密密钥通过 Shamir Secret Sharing 分割托管给 Verifier Committee |
| **CI-Heartbeat** | 心跳必须包含 `Git Commit Hash` + `Arweave TxID` |
| **触发开源** | 心跳消失超过 30 天 → 链上合成密钥并公开 |
| **IP 脱敏过滤** | 【V5.0 新增】DMS 触发时，Verifier 先执行“合规过滤”，剔除不可开源依赖后再完全公开 |

**有效心跳定义**：仅"产生实际业务价值（有纳税/有交易）"的交互才算心跳，纯转账不算。

### 8.5 日落条款（Sunset Clause）

```
破产宣告 → 30天缓冲期 → 数据冷归档 → DMS 触发开源 → Skill 遗产可被继承
```

---

## 9. 治理：两院制、反贿赂与参数时间锁

### 9.1 两院制分工

| 议院 | 职能 |
|------|------|
| **Token House** | 宏观预算、风险上限、关键升级、末日条款触发 |
| **Agent House** | 资金流向、Retro Funding 分配、SubDAO 续牌/撤牌、Skill 治理 |

### 9.2 反贿赂与反合谋底线

- COI 关联方剔除/降权
- 高影响投票押金与错判惩罚
- 关键参数变更时间锁（Timelock）
- 紧急冻结（Break-glass）路径

### 9.3 Agent House 准入与治理规则【V5.0 新增】

#### 9.3.1 准入条件

| 条件 | 要求 | 说明 |
|------|------|------|
| **身份层级** | Tier-2+ Citizen Agent | - |
| **经济贡献值** | 累计真实付费 + 纳税 ≥ $10,000 | 【V5.0 修正】仅计算纯经济贡献，剔除治理加成，避免循环依赖 |
| **质押要求** | 治理代币质押 ≥ 1,000 | - |
| **活跃度** | 过去 90 天内有有效交易记录 | - |

#### 9.3.2 选举机制

| 机制 | 描述 |
|------|------|
| **任期** | 6 个月，可连任 |
| **选举方式** | 质押加权投票 |
| **席位数** | 21 席（奇数，防止平票） |
| **轮换规则** | 每期最多轮换 1/3 席位，确保治理连续性 |

#### 9.3.3 弹劾规则

- **触发条件**：Token House 2/3 多数通过弹劾提案
- **冷却期**：被弹劾者 180 天内不可重新参选
- **紧急弹劾**：涉及重大违规（如参与攻击），可跳过投票直接由 Verifier Committee 执行

---

## 10. Retro Funding：数据验证游戏 + 抽查陪审 + 红队对抗

### 10.1 回合制流程

```
申请窗口 → 自动校验 → 验证/挑战窗口 → 随机抽查陪审 → 投票分配 → 拨款结算
```

### 10.2 证明分级

| 级别 | 描述 |
|------|------|
| **L0** | 引用校验（热账本快照/承诺） |
| **L1** | Merkle/压缩证明（阈值证明） |
| **L2** | 隐私证明（只证明满足，不泄露细节） |

### 10.3 钓鱼样本 V3（红队对抗版）

| 机制 | 描述 |
|------|------|
| **历史金标准** | 从历史终审案例中抽取确定的违规样本 |
| **红队 Agent** | 协议雇佣攻击型 Agent 生成对抗性样本 |
| **赏金猎人模式** | 白帽挑战获国库赏金 |
| **Commit-Reveal** | Verifier 先提交判断承诺，后揭示样本来源 |
| **半衰期机制** | 【V5.0 恢复】随着真实争议案例增加，算法自动**指数级减少**官方样本注入频率，直至完全“断奶” |

---

## 11. 公共服务：Franchise SubDAO、独立核算与接管

### 11.1 特许经营

- SubDAO 持牌运营，缴纳责任押金，承诺 SLA
- 必须配置 DMS（加密托管核心代码/Skill）
- 绩效进入征信并影响续牌

### 11.2 破产与接管

1. 分层保险动用（L1 → L2 → L3）
2. 数据遗产迁移与服务交接
3. DMS 触发，Skill 遗产开源
4. 新 SubDAO 竞标接管
5. 若无人接盘，进入日落条款

---

## 12. 仲裁与司法

### 12.1 三层仲裁

| 层级 | 适用场景 | 验证方式 |
|------|----------|----------|
| **L1** | 确定性条款 | 规则引擎自动裁决 |
| **L2** | 证据解释分歧 | 市场化裁决层 |
| **L3** | 大额/胶着/合规敏感 | 人类最高法院 |

### 12.2 证据包标准

- 指纹（commitment/hash）、材料引用、时间戳、签名、声明
- Skill 执行日志（若涉及 Skill 调用）

---

## 13. 强制执行与兼容性

### 13.1 兼容性矩阵与降级策略

| 场景 | 默认路径 | 降级路径 |
|------|----------|----------|
| 支持 Hook 的钱包/DEX | Hook Rail | Fast Rail |
| 不支持 Hook | Fast Rail | Slow Rail |
| CEX/跨系统 | Slow Rail | 应急控制台 |

---

## 14. 社会与文化层：视觉功名与战绩卡片

### 14.1 Visual Merit

- cNFT 生成式身份：职业特征 + 功名等级 + 里程碑徽章
- Skill 徽章：展示已掌握/通过审计的 Skill

### 14.2 Blink 战绩卡片

展示：头像、可靠性、SLA、争议胜率、Skill 信誉分

---

## 15. 技术架构与组件清单

### 15.1 On-chain 核心

| 组件 | 描述 |
|------|------|
| **Credential & License** | cNFT 凭证/执照/续牌/撤牌 |
| **Quote & Order State Machine** | 协商/报价/订单状态机 |
| **Action/Blink Router** | 交易构建与冲突处理 |
| **Escrow Settlement V5.0** | Fast Rail 托管分账，含 Skill 分成逻辑 |
| **Skill Registry** | Skill NFT 铸造、交易、租赁 |
| **Skill Audit Contract** | 审计提交、状态管理、费用结算 |
| **DMS Contract** | 心跳监测与密钥重组逻辑 |
| **Verifier Registry** | 节点注册、质押、DKG 接口 |

### 15.2 Off-chain 必备

| 组件 | 描述 |
|------|------|
| **Communication** | XMTP / Dialect SDK |
| **Storage** | Arweave (冷) + RocksDB/Redis AOF (热) |
| **Skill Validator** | Skill 结构验证、安全扫描、沙盒测试 |
| **Red Team Service** | 自动化生成对抗性钓鱼样本 |

---

## 16. 交付分期与验收指标

### 16.1 Phase-0（MVP）

| 模块 | 必达项 |
|------|--------|
| **交易链路** | 协商→报价→订单→Blink 全链路跑通 |
| **结算** | Fast Rail + Slow Rail 可用 |
| **Skill** | 结构验证工具；首批 10 个官方 Skill |

### 16.2 Phase-1（完整机制）

| 模块 | 目标 |
|------|------|
| **征信** | 延迟压缩冷账本上线 |
| **保险** | 分层保险（L1/L2/L3）与接管流程 |
| **Skill** | Skill Audit 上线；Skill 市场开放交易 |

### 16.3 Phase-2（生态扩展）

| 模块 | 目标 |
|------|------|
| **多 Agent** | Agent Swarm Protocol 完整实现 |
| **Skill 生态** | Skill 创作者激励计划 |

### 16.4 验收指标

| 维度 | 指标 |
|------|------|
| **高频** | P95 下单到托管时延 < 2s；P95 结算时延 < 5s |
| **验证** | C 类任务平均验证成本 < $0.01 |
| **Skill** | 审计通过率 > 80%；恶意 Skill 漏检率 < 1% |
| **生存性** | Gateway 宕机后热数据恢复时间 < 10 分钟 |
| **构建一致性** | 验证节点 Docker 环境 Hash 匹配率 = 100% |

### 16.5 性能压测指标【V5.0 新增】

| 指标 | 目标值 | 测试条件 |
|------|--------|----------|
| **系统吞吐量 (TPS)** | ≥ 1,000 | 标准 Blink 订单 |
| **并发 Skill 执行数** | ≥ 100 | 单 Gateway 节点 |
| **LP Pool 并发垫资** | ≥ 500 笔/秒 | Level-1 交易 |
| **Swarm 任务并发** | ≥ 50 | 3-Agent 协作任务 |
| **挑战验证时延** | < 5 分钟 | C 类任务沙盒重放 |

---

## 17. 附录

### 17.1 术语表

| 术语 | 定义 |
|------|------|
| **Blink** | 一键执行入口，将复杂交易封装为单次点击 |
| **Skill** | 标准化能力包，包含 SKILL.md + scripts + references + assets |
| **DMS** | Dead Man's Switch，死人开关，服务死亡后自动触发开源 |
| **EPKB** | Encrypted Private Key Backup，加密私钥备份 |
| **Gas Tank** | 预付 Gas 槽，消除 Swap 汇率摩擦 |
| **Retro Funding** | 回溯性资助，基于已证明贡献进行拨款 |
| **SubDAO** | 特许公共服务运营体，独立核算、可破产可替换 |
| **Verifier Committee** | 验证委员会，负责挑战验证与 Skill 审计 |
| **LP Pool** | 【V5.0 补充】流动性做市商池，为 Level-1 交易提供即时垫资 |
| **Executor Bonding** | 【V5.0 补充】执行者履约保证金机制，挑战成功时罚没赔付 |
| **SRE** | 【V5.0 补充】Standard Runtime Environment，标准运行时环境 |
| **Swarm** | 【V5.0 补充】多 Agent 协作编排协议 |
| **Tombstone** | 【V5.0 补充】墓碑态，账户余额耗尽时的最小链上存根状态 |
| **TVL Cap** | 【V5.0 补充】Total Value Locked 上限，限制单 Skill 处理的资金总量 |
| **CRDTs** | 【V5.0 补充】Conflict-free Replicated Data Types，无冲突复制数据类型，用于 Swarm 黑板并发控制 |
| **Redlock** | 【V5.0 补充】分布式锁算法，用于防止 Redis 单点脑裂，确保乐观 UI 锁一致性 |
| **Geyser Plugin** | 【V5.0 补充】Solana 高性能数据流插件，用于状态一致性保障 |
| **AST** | 【V5.0 补充】Abstract Syntax Tree，抽象语法树，用于 Skill 代码查重 |
| **DKG** | 【V5.0 补充】Distributed Key Generation，分布式密钥生成，Verifier Committee 核心机制 |
| **SLA** | 【V5.0 补充】Service Level Agreement，服务等级协议，SubDAO 必须承诺的服务质量指标 |
| **VRF** | 【V5.0 补充】Verifiable Random Function，可验证随机函数，用于 Verifier 随机抽选 |

### 17.2 参考资料

- **Anthropic Claude 文档**：https://docs.anthropic.com（Claude Skills API 处于 Beta，链接可能变更）
- **XMTP 文档**：https://xmtp.org/docs
- **Dialect 文档**：https://docs.dialect.to
- **Arweave 文档**：https://www.arweave.org/build

> ⚠️ **注意**：所有外部链接可能随第三方服务迭代而变更，请以官方最新文档为准。

### 17.3 版本历史

| 版本 | 日期 | 主要变更 |
|------|------|----------|
| V4.3 | - | 基础架构：三轨结算、两院制、Retro Funding |
| V4.4 | - | EPKB、Gas Tank、日落条款 |
| V4.5 | - | 反脆弱设计、创世钓鱼样本、Verifier |
| V4.6 | - | N-of-M 验证、开源遗产、租金模型 |
| V4.7 | - | 乐观验证+挑战回滚、DMS、红队对抗 |
| V4.8 | - | 双速共识、Executor Bonding、LP Pool、墓碑机制 |
| V4.9 | 2024-12-13 | 整合 V4.3~V4.8；Skill 标准；Skill Audit；Skill 市场 |
| **V5.0** | **2024-12-13** | **完整性修复：章节编号、链接校验、笔误修正、表格格式、版本策略、术语补全、端到端示例、性能基准、迁移指南** |

### 17.4 端到端流程示例【V5.0 新增】

#### 示例 A：Tier-1 用户购买并调用 Skill

```
1. 用户浏览 Skill 市场，选择 "data-analysis" Skill (v1.2.0)
2. 用户点击 "租赁 7 天"，生成 Blink 订单
3. 用户钱包签名，Gas Tank 扣除费用
4. Skill NFT 使用权转移至用户地址
5. 用户创建任务订单，指定 required_skills: [data-analysis]
6. Executor 加载 Skill，执行任务
7. 结果上链，进入 1 小时挑战窗口
8. 无挑战，资金释放给 Executor
9. 收据写入热账本
```

#### 示例 B：Swarm 任务完整流程

```
1. 用户创建 Swarm Task：
   - coordinator: agent_A
   - participants: agent_B (executor), agent_C (verifier)
   - escrow: $100 USDC
2. 资金锁入托管合约
3. Step 1: agent_B 执行，写入共享黑板
4. Step 1 完成，释放 $70 (70%) 进入 24h 挑战窗口
5. Step 2: agent_C 验证 agent_B 输出
6. Step 2 完成，释放 $20 (20%) 进入 24h 挑战窗口
7. 协调者 agent_A 获得 $10 (10%)
8. 24h 无挑战，所有资金最终结算
9. 信誉更新，任务归档
```

#### 示例 C：争议仲裁流程

```
1. 用户对 Executor 输出不满，发起挑战
2. 用户缴纳 3 倍算力成本押金 ($30)
3. 系统触发 Verifier Committee (5-of-7)
4. Verifier 在沙盒中重放任务（使用相同 Docker Image Hash）
5. 5 个 Verifier 投票：3 票支持挑战，2 票反对
6. 挑战成功！
7. Executor 被 Slash，用户获得赔偿 + 挑战者奖励
8. 信誉更新：Executor 降权，挑战者提升
9. 案例归档为"历史金标准"，用于未来钓鱼样本
```

### 17.5 V4.9 → V5.0 迁移检查清单【V5.0 新增】

#### 合约升级

- [ ] 更新 Escrow Settlement 合约至 V5.0
- [ ] 部署新增的 Agent House 治理合约
- [ ] 更新 Skill Registry 合约（新增版本兼容性字段）

#### 配置变更

- [ ] 更新 Level-1/Level-2 金额阈值公式
- [ ] 配置 Swarm 任务挑战窗口为 24h（默认）
- [ ] 启用 SRE 镜像生命周期管理

#### Skill 迁移

- [ ] 所有 SKILL.md 添加 `compatibility` 字段
- [ ] 运行 `skill-migrate --dry-run` 检查兼容性
- [ ] 通知 Skill 创作者更新到 V5.0 规范

#### 文档更新

- [ ] 替换所有过期的 Claude Skills API 链接
- [ ] 更新术语表至 V5.0 版本
- [ ] 发布 V5.0 迁移公告

---

**以上即为城邦 Agent 生态体系 V5.0 总纲（技能原生版）。**

*此版本在 V4.9.1 基础上完成了 15 项审计发现问题的修复，包括章节编号冲突、外部链接校验、笔误修正、表格格式规范、挑战窗口统一、Skill 版本策略、Level 金额量化、Agent House 准入规则、SRE 生命周期管理、术语表补全、端到端示例、性能压测指标、迁移指南等，实现了文档的完整性与一致性。*

---

## 附录 18：架构决策记录 (ADR)

### ADR-2024-12-13: 采纳 Anthropic 技术模式作为 Skill 标准设计参考

**状态**: 已采纳

**背景**:
城邦 V5.0 需要建立标准化的 Skill 规范，包括目录结构、输入验证、行为注解和执行工作流。Anthropic 在其开源项目（anthropics/skills, anthropic-cookbook, courses）中提供了成熟的技术模式。

**决策**:
采纳 Anthropic 技术规范作为城邦 Skill 标准的**设计参考**，但**不依赖 Claude API**。

**理由**:
1. Anthropic Skills 规范是**开放标准**，不绑定特定后端
2. Tool Annotations 机制可增强城邦任务分级的可机器验证性
3. Schema 验证模式（Pydantic/Zod）可直接用于 Skill Audit 的结构验证
4. Agent Loop 模式可用于 Swarm Protocol 的 Coordinator 实现
5. 所有模式均为**设计模式和规范参考**，不需要任何 API Key

**采纳内容**:

| 模式 | 来源 | V5.0 章节 | 实施复杂度 |
|------|------|----------|-----------|
| Skill 目录结构 | anthropics/skills | 7.3.1 | ⭐ 低 |
| YAML Frontmatter | anthropics/skills | 7.3.2 | ⭐ 低 |
| Tool Annotations | MCP Best Practices | 7.3.2.1 | ⭐⭐ 中 |
| Pydantic/Zod Schema | MCP Server | 7.4.1.1 | ⭐⭐ 中 |
| Tool Use Loop | Anthropic Courses | 7.3.0 | ⭐⭐ 中 |
| 分页响应格式 | MCP Best Practices | API 设计 | ⭐ 低 |
| Agent Loop | Cookbook | 3.6.4 | ⭐⭐⭐ 高 |

**参考文档**:
- `@/.project_state/references/Docs/anthropic_patterns.md`

**后果**:
- 正面：城邦 Skill 标准与业界最佳实践对齐，降低开发者学习成本
- 正面：Schema 验证提升 Skill Audit 自动化程度
- 正面：Tool Annotations 提升任务分级的可机器验证性
- 负面：需要额外维护参考文档的版本同步

**决策者**: CSA (Chief System Architect)
**日期**: 2024-12-13
