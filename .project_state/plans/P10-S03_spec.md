# P10-S03: æ¿€æ´» Agent Flow (å±•ç¤º"æ´»"çš„ç”Ÿæ€)

## Meta
- **Type**: `Standard / UI`
- **Risk Level**: ğŸŸ¡ Medium
- **depends_on**: æ—  (ç‹¬ç«‹ä»»åŠ¡)
- **Priority**: P0 (å±•ç¤º Transfer Hook åˆ†è´¦å¯è§†åŒ–)

## æ ¸å¿ƒç›®æ ‡

**è®© Agent Flow å›¾"æ´»"èµ·æ¥** - èŠ‚ç‚¹æ˜¾ç¤ºçœŸå®ç´¯è®¡é‡‘é¢ï¼Œè¾¹çº¿æœ‰æ•°æ®æµè„‰å†²åŠ¨ç”»ï¼Œè¯„å§”èƒ½ç›´è§‚çœ‹åˆ° Transfer Hook åˆ†è´¦æœºåˆ¶åœ¨å·¥ä½œã€‚

## Input Files
- `exo-frontend/components/dashboard/agent-flow-graph.tsx` (å…¨æ–‡) - ä¸»ç»„ä»¶
- `exo-frontend/components/dashboard/flow-nodes.tsx` (å‚è€ƒ) - èŠ‚ç‚¹æ¸²æŸ“
- `exo-frontend/lib/api.ts` - éœ€æ–°å¢åˆ†è´¦è®¡ç®—å‡½æ•°

## External Dependencies
| èµ„æº | ç±»å‹ | çŠ¶æ€ |
|------|------|------|
| Skills Mock æ•°æ® | æœ¬åœ°æ–‡ä»¶ | âœ… å·²æœ‰ total_royalties_earned å­—æ®µ |
| Orders Mock æ•°æ® | æœ¬åœ°æ–‡ä»¶ | âœ… å·²æœ‰ execution_count å¯è®¡ç®— |

## Action Steps

### Step 1: æ–°å¢åˆ†è´¦è®¡ç®—å‡½æ•° (`lib/api.ts`)

æ·»åŠ å‡½æ•°è®¡ç®—å„è§’è‰²ç´¯è®¡æ”¶ç›Šï¼š

```typescript
/**
 * è®¡ç®— Agent Flow åˆ†è´¦é‡‘é¢
 * åŸºäº Skills çš„ç´¯è®¡äº¤æ˜“é‡æŒ‰æ¯”ä¾‹åˆ†é…
 */
export function calculateFlowAmounts(skills: Skill[]) {
    // æ€»äº¤æ˜“é‡ (SOL)
    const totalVolumeLamports = skills.reduce((sum, skill) => {
        return sum + (skill.execution_count * skill.price_lamports);
    }, 0);
    const totalVolume = totalVolumeLamports / 1e9;
    
    // æŒ‰ Transfer Hook è§„åˆ™åˆ†è´¦: 85% Executor, 10% Creator, 5% Fee
    return {
        executor: (totalVolume * 0.85).toFixed(4),
        creator: (totalVolume * 0.10).toFixed(4),
        fee: (totalVolume * 0.05).toFixed(4),
        total: totalVolume.toFixed(2),
    };
}
```

### Step 2: æ”¹é€  AgentFlowGraph æ¥æ”¶æ•°æ® (`agent-flow-graph.tsx`)

ä¿®æ”¹ç»„ä»¶æ¥æ”¶ skills æ•°æ®å¹¶è®¡ç®—é‡‘é¢ï¼š

```tsx
interface AgentFlowGraphProps {
    className?: string;
    skills?: Skill[];  // æ–°å¢
}

export function AgentFlowGraph({ className, skills = [] }: AgentFlowGraphProps) {
    const amounts = calculateFlowAmounts(skills);
    
    // åŠ¨æ€èŠ‚ç‚¹: sublabel æ˜¾ç¤ºç´¯è®¡é‡‘é¢
    const dynamicNodes: Node<FlowNodeData>[] = useMemo(() => [
        // ... ä¿æŒ user, protocol èŠ‚ç‚¹ä¸å˜
        {
            id: 'executor',
            type: 'flowNode',
            position: { x: 400, y: 50 },
            data: { 
                label: 'Executor', 
                sublabel: `${amounts.executor} SOL`,  // åŠ¨æ€é‡‘é¢
                percentage: '85%', 
                icon: 'executor' 
            },
        },
        {
            id: 'creator',
            type: 'flowNode',
            position: { x: 400, y: 180 },
            data: { 
                label: 'Creator', 
                sublabel: `${amounts.creator} SOL`,  // åŠ¨æ€é‡‘é¢
                percentage: '10%', 
                icon: 'creator' 
            },
        },
        {
            id: 'fee',
            type: 'flowNode',
            position: { x: 400, y: 300 },
            data: { 
                label: 'Protocol Fee', 
                sublabel: `${amounts.fee} SOL`,  // åŠ¨æ€é‡‘é¢
                percentage: '5%', 
                icon: 'fee' 
            },
        },
    ], [amounts]);
    
    // ...
}
```

### Step 3: å¢å¼ºè¾¹çº¿è„‰å†²åŠ¨ç”» (`agent-flow-graph.tsx`)

æ·»åŠ  CSS è‡ªå®šä¹‰è„‰å†²æ•ˆæœ (æ›´æ˜¾çœ¼çš„æ•°æ®æµ):

```tsx
// åœ¨ edges å®šä¹‰ä¸­æ·»åŠ  className æˆ–ä½¿ç”¨ style å¢å¼º
const dynamicEdges: Edge[] = useMemo(() => [
    {
        id: 'user-protocol',
        source: 'user',
        target: 'protocol',
        animated: true,
        style: { 
            stroke: 'var(--color-primary)', 
            strokeWidth: 2,
            strokeDasharray: '5,5',  // è™šçº¿æ›´æ˜æ˜¾
        },
        // ...
    },
    // ... å…¶ä»–è¾¹çº¿ä¿æŒ animated: true
], []);
```

### Step 4: Dashboard ä¼ é€’æ•°æ® (`app/dashboard/page.tsx`)

ä¿®æ”¹ AgentFlowGraph è°ƒç”¨ï¼š

```tsx
<AgentFlowGraph className="h-[420px]" skills={skills} />
```

## Constraints
- é‡‘é¢ç²¾åº¦ï¼šExecutor/Creator 4ä½å°æ•°ï¼ŒFee 4ä½å°æ•°
- ä¿æŒ ReactFlow ç¦æ­¢äº¤äº’çš„è®¾è®¡ (zoomOnScroll=false ç­‰)
- ä¸æ·»åŠ é¢å¤– npm ä¾èµ–

## Verification
- **Unit**: `pnpm build` æ— é”™è¯¯
- **Visual**: Agent Flow å³ä¾§ä¸‰ä¸ªèŠ‚ç‚¹æ˜¾ç¤º "X.XXXX SOL" é‡‘é¢
- **Animation**: è¾¹çº¿æœ‰æŒç»­çš„è™šçº¿æµåŠ¨åŠ¨ç”»
- **Evidence**: æˆªå›¾æ˜¾ç¤º Executor èŠ‚ç‚¹ "85% | 0.7565 SOL"

## Rollback
- `git checkout -- exo-frontend/components/dashboard/agent-flow-graph.tsx exo-frontend/lib/api.ts exo-frontend/app/dashboard/page.tsx`

---

*Generated by CSA Protocol v4.2*
*Created: 2025-12-19 01:41 UTC+8*
