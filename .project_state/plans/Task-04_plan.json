{
  "task_id": "Task-04",
  "title": "Agent Identity 合约",
  "status": "DISPATCHED",
  "created_at": "2025-12-14T02:10:00+08:00",
  "priority": "HIGH",
  "depends_on": ["Task-03"],
  "external_dependencies": [],
  "description": "实现 Agent Identity 链上身份合约，基于 MVP v2.0.md §3.2.2 和 AGENT_STANDARD.md 规范",

  "input": {
    "spec_files": [
      "docs/mvp v2.0.md §3.2.2",
      "exo-protocol/docs/AGENT_STANDARD.md"
    ],
    "existing_code": [
      "anchor/programs/exo-core/src/lib.rs",
      "anchor/programs/exo-core/src/state/mod.rs",
      "anchor/programs/exo-core/src/instructions/mod.rs"
    ]
  },

  "output": {
    "files": [
      {
        "path": "anchor/programs/exo-core/src/state/agent.rs",
        "description": "AgentIdentity 账户结构体"
      },
      {
        "path": "anchor/programs/exo-core/src/instructions/create_agent.rs",
        "description": "3个指令: create_agent, upgrade_tier, update_reputation"
      }
    ],
    "integration": [
      "更新 state/mod.rs 导出 AgentIdentity",
      "更新 instructions/mod.rs 导出指令",
      "更新 lib.rs 注册指令入口"
    ]
  },

  "spec": {
    "account_structure": {
      "name": "AgentIdentity",
      "fields": [
        { "name": "owner", "type": "Pubkey", "description": "所有者钱包" },
        { "name": "tier", "type": "u8", "description": "0=Open, 1=Verified, 2=Premium" },
        { "name": "total_earnings", "type": "u64", "description": "累计收入 (lamports)" },
        { "name": "total_tasks", "type": "u64", "description": "累计完成任务数" },
        { "name": "reputation_score", "type": "u16", "description": "信誉分 (0-10000, 默认5000)" },
        { "name": "created_at", "type": "i64", "description": "创建时间戳" },
        { "name": "bump", "type": "u8", "description": "PDA bump" }
      ],
      "pda_seeds": ["agent", "owner"]
    },
    "instructions": [
      {
        "name": "create_agent",
        "description": "铸造 Agent 身份",
        "permission": "任何人",
        "args": []
      },
      {
        "name": "upgrade_tier",
        "description": "升级 Tier (检查条件)",
        "permission": "满足条件的 Agent owner",
        "args": []
      },
      {
        "name": "update_reputation",
        "description": "更新信誉分",
        "permission": "仅协议合约 (authority)",
        "args": [{ "name": "delta", "type": "i16" }]
      }
    ],
    "tier_rules": [
      { "from": 0, "to": 1, "condition": "total_earnings >= 1_000_000_000 (1 SOL)" },
      { "from": 1, "to": 2, "condition": "total_earnings >= 10_000_000_000 (10 SOL) && reputation_score >= 8000" }
    ],
    "constants": {
      "DEFAULT_REPUTATION": 5000,
      "MAX_REPUTATION": 10000,
      "MIN_REPUTATION": 0
    }
  },

  "verify": {
    "unit": [
      {
        "command": "cargo build-sbf --manifest-path programs/exo-core/Cargo.toml",
        "expect": "exit_code: 0"
      }
    ],
    "evidence_required": [
      "target/deploy/exo_core.so (更新)",
      "target/idl/exo_core.json (含新指令)"
    ]
  },

  "note_to_wap": "请严格遵循 AGENT_STANDARD.md 中的字段定义和 PDA 种子。update_reputation 指令需要添加 authority 签名验证，防止任意账户修改信誉分。"
}
